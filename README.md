# üöÄ nginx-domain-provisioner

–£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–¥–æ–º–µ–Ω–∞–º–∏ –Ω–∞ VDS —Å –ø–æ–º–æ—â—å—é **Nginx** –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (**Let‚Äôs Encrypt, Certbot**).

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ nginx-–∫–æ–Ω—Ñ–∏–≥–æ–≤ –¥–ª—è –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS —á–µ—Ä–µ–∑ Certbot –∑–∞ –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É
- –ì–∏–±–∫–∞—è IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ (—á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–Ω–∏—á–µ–≥–æ –≤—Ä—É—á–Ω—É—é –¥–µ–ª–∞—Ç—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
- –£–¥–æ–±–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
nginx-domain-provisioner/
‚îú‚îÄ‚îÄ add_subdomain.sh              # –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ‚îÄ includes/
‚îÇ   ‚îú‚îÄ‚îÄ allowed_ips.conf          # —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö IP
‚îÇ   ‚îî‚îÄ‚îÄ no_ip_restriction.conf    # –ø—É—Å—Ç–æ–π include (–¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)
‚îú‚îÄ‚îÄ README.md                     # –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îî‚îÄ‚îÄ SETUP.md                      # –ø–æ—à–∞–≥–æ–≤–∞—è –ø–∞–º—è—Ç–∫–∞ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é
```

## ‚ö°Ô∏è –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –¥–ª—è –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤.
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS —Å Certbot.
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx.
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (`allow/deny`).
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **–ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –∏ –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤**.
- ‚úÖ –£–¥–æ–±–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–¥–æ–º–µ–Ω–∞ + —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞).

## üõ† –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–ù–∞ **Ubuntu 20.04/22.04/24.04**:

### 1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∞

```bash
# –°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone https://github.com/yourname/nginx-domain-provisioner.git
cd nginx-domain-provisioner
chmod +x add_subdomain.sh
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å—Ç–æ—è—Ç)

```bash
    sudo apt-get remove certbot, sudo dnf remove certbot, or sudo yum remove certbot

    sudo apt update
    sudo apt install snapd

    sudo snap install --classic certbot
    sudo ln -s /snap/bin/certbot /usr/bin/certbot

    sudo certbot --nginx

    sudo certbot renew --dry-run
    sudo systemctl restart nginx 
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∞–π–ª—ã IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

```bash
sudo mkdir -p /etc/nginx/includes

# –ü—Ä–∏–º–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
sudo nano /etc/nginx/includes/allowed_ips.conf
# –ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ:
allow 77.51.44.117;   # JOB
allow 89.188.168.102; # HOME
allow 172.18.0.0/16;  # Docker
deny all;
# –î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥
sudo touch /etc/nginx/includes/no_ip_restriction.conf
```

### 4. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–¥–æ–º–µ–Ω

- –ü—É–±–ª–∏—á–Ω—ã–π (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π):

```bash
  sudo ./add_subdomain.sh read.app.tw1.ru 3000 no
```

- –° —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ IP:

```bash
sudo ./add_subdomain.sh feed.app.tw1.ru 3000 yes
```

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS-–∑–∞–ø–∏—Å—å:

```bash
dig +short app.crm-tg-mini-app.tw1.ru
```

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å nginx:

```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 6. –ì–æ—Ç–æ–≤–æ

- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø—Ä–æ–¥–ª–µ–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–º. SETUP.md).
- –î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–π —à–∞–≥ 4.
- –î–ª—è —Å–º–µ–Ω—ã IP-–¥–æ—Å—Ç—É–ø–∞ ‚Äî –º–µ–Ω—è–π —Ç–æ–ª—å–∫–æ allowed_ips.conf –∏ –¥–µ–ª–∞–π systemctl reload nginx.

## üßπ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–¥–æ–º–µ–Ω–∞

```bash
sudo rm /etc/nginx/sites-enabled/<domain>.conf
sudo rm /etc/nginx/sites-available/<domain>.conf
sudo certbot delete --cert-name <domain>
sudo systemctl reload nginx
```

## üí° –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ‚Äî —Å–º–æ—Ç—Ä–∏ SETUP.md

MIT License ¬© 2025
